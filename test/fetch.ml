open Hardcaml
open Hardcaml_waveterm
module Simulator = Cyclesim.With_interface (Risk5.Fetch.I) (Risk5.Fetch.O)

let program = List.map (Signal.of_int ~width:32) [ 1; 2; 3; 4 ]

let testbench () =
  let scope = Scope.create ~flatten_design:true () in
  let sim = Simulator.create (Risk5.Fetch.circuit program scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  let step branch_target pc_sel =
    inputs.branch_target := Bits.of_int ~width:32 branch_target;
    inputs.pc_sel := Bits.of_int ~width:1 pc_sel;
    Cyclesim.cycle sim
  in

  step 0 0;
  step 0 0;
  step 32 1;
  step 0 0;
  step 0 0;
  step 12 1;
  step 0 0;
  step 0 0;

  waves

let%expect_test "fetch" =
  let waves = testbench () in
  Waveform.print ~wave_width:4 ~display_width:160 waves;

  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐  │
    │                  ││     └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └──│
    │                  ││────────────────────┬─────────┬───────────────────┬─────────┬───────────────────                                                          │
    │branch_target     ││ 00000000           │00000020 │00000000           │0000000C │00000000                                                                     │
    │                  ││────────────────────┴─────────┴───────────────────┴─────────┴───────────────────                                                          │
    │pc_sel            ││                    ┌─────────┐                   ┌─────────┐                                                                             │
    │                  ││────────────────────┘         └───────────────────┘         └───────────────────                                                          │
    │                  ││──────────┬─────────┬─────────┬─────────────────────────────────────────────────                                                          │
    │instruction       ││ 00000001 │00000002 │00000003 │00000004                                                                                                   │
    │                  ││──────────┴─────────┴─────────┴─────────────────────────────────────────────────                                                          │
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────                                                          │
    │pc                ││ 00000000 │00000004 │00000008 │00000020 │00000024 │00000028 │0000000C │00000010                                                           │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────                                                          │
    │                  ││                                                                                                                                          │
    │                  ││                                                                                                                                          │
    │                  ││                                                                                                                                          │
    │                  ││                                                                                                                                          │
    │                  ││                                                                                                                                          │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘|}]
